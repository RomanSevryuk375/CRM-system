<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="CRMSystemMobile.View.MyCarsPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:contracts="clr-namespace:Shared.Contracts.Car;assembly=Shared"
    xmlns:d="http://schemas.microsoft.com/dotnet/2021/maui/design"
    xmlns:vm="clr-namespace:CRMSystemMobile.ViewModels"
    Title="Мои автомобили"
    x:DataType="vm:MyCarsViewModel"
    Shell.NavBarIsVisible="False">

    <Grid BackgroundColor="#112347" RowDefinitions="Auto, *">

        <!--  Header  -->
        <Grid
            Grid.Row="0"
            Padding="20,20,20,10"
            ColumnDefinitions="50, *, 50"
            HeightRequest="80"
            VerticalOptions="End">

            <ImageButton
                Command="{Binding GoBackCommand}"
                HeightRequest="24"
                HorizontalOptions="Start"
                Source="back_icon.png"
                WidthRequest="24" />

            <Label
                Grid.Column="1"
                FontAttributes="Bold"
                FontSize="20"
                HorizontalOptions="Center"
                Text="Мои автомобили"
                TextColor="White"
                VerticalOptions="Center" />

            <Border
                Grid.Row="0"
                Grid.Column="2"
                BackgroundColor="#ffffff"
                HeightRequest="50"
                StrokeShape="RoundRectangle 25"
                StrokeThickness="0"
                WidthRequest="50">
                <ImageButton
                    Padding="8"
                    Command="{Binding ToggleMenuCommand}"
                    Source="show_menu.svg" />
            </Border>
        </Grid>

        <!--  Main Content Area  -->
        <Grid Grid.Row="1">
            <!--  List  -->
            <RefreshView
                Command="{Binding LoadInitialCommand}"
                IsRefreshing="{Binding IsRefreshing}"
                RefreshColor="#112347">

                <CollectionView
                    Margin="0,10,0,0"
                    ItemsSource="{Binding Cars}"
                    RemainingItemsThreshold="2"
                    RemainingItemsThresholdReachedCommand="{Binding LoadNextPageCommand}">
                    <CollectionView.EmptyView>
                        <StackLayout HorizontalOptions="Center" VerticalOptions="Center">
                            <Label Text="Нет добавленных автомобилей" TextColor="Gray" />
                        </StackLayout>
                    </CollectionView.EmptyView>

                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="contracts:CarResponse">
                            <Border
                                Margin="15,8"
                                Padding="15"
                                BackgroundColor="#213868"
                                Stroke="Transparent"
                                StrokeShape="RoundRectangle 12">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MyCarsViewModel}}, Path=GoToDetailsCommand}" CommandParameter="{Binding .}" />
                                </Border.GestureRecognizers>
                                <Grid ColumnDefinitions="Auto, Auto">
                                    <Image
                                        Margin="20"
                                        Aspect="AspectFit"
                                        HeightRequest="40"
                                        Source="car_placeholder.png" />

                                    <VerticalStackLayout
                                        Grid.Column="1"
                                        Spacing="4"
                                        VerticalOptions="Center">
                                        <Label
                                            FontAttributes="Bold"
                                            FontSize="16"
                                            TextColor="White">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="{Binding Brand}" />
                                                    <Span Text=" " />
                                                    <Span Text="{Binding Model}" />
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>

                                        <Label
                                            FontSize="14"
                                            Text="{Binding StateNumber}"
                                            TextColor="#FFB347" />

                                        <Label FontSize="12" TextColor="#ACACAC">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="VIN: " />
                                                    <Span Text="{Binding VinNumber}" />
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>
                                    </VerticalStackLayout>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                    <CollectionView.Footer>
                        <ActivityIndicator
                            IsRunning="{Binding IsLoadingMore}"
                            IsVisible="{Binding IsLoadingMore}"
                            Color="White" />
                    </CollectionView.Footer>
                </CollectionView>
            </RefreshView>

            <!--  Floating Action Button  -->
            <Border
                Margin="0,0,20,30"
                BackgroundColor="White"
                HeightRequest="60"
                HorizontalOptions="End"
                StrokeShape="RoundRectangle 30"
                StrokeThickness="0"
                VerticalOptions="End"
                WidthRequest="60">

                <Border.Shadow>
                    <Shadow
                        Brush="Black"
                        Opacity="0.5"
                        Radius="5"
                        Offset="2,2" />
                </Border.Shadow>

                <Border.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding GoToAddCarCommand}" />
                </Border.GestureRecognizers>

                <Label
                    Margin="0,-2,0,0"
                    FontSize="36"
                    HorizontalOptions="Center"
                    Text="+"
                    TextColor="#112347"
                    VerticalOptions="Center" />

            </Border>

            <!--  Loading Indicator  -->
            <ActivityIndicator
                HorizontalOptions="Center"
                IsRunning="{Binding IsBusy}"
                IsVisible="{Binding IsBusy}"
                VerticalOptions="Center"
                Color="White" />
        </Grid>
        <Grid
            Grid.Row="0"
            Grid.RowSpan="2"
            BackgroundColor="Transparent"
            IsVisible="{Binding IsMenuOpen}">
            <Grid RowDefinitions="*, Auto">
                <BoxView Grid.Row="0" BackgroundColor="#80000000">
                    <BoxView.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding ToggleMenuCommand}" />
                    </BoxView.GestureRecognizers>
                </BoxView>
                <Border
                    Grid.Row="1"
                    BackgroundColor="#1C2D4F"
                    HeightRequest="{OnPlatform Default=350}"
                    StrokeThickness="0"
                    VerticalOptions="End">

                    <Grid
                        Padding="20,0,20,20"
                        RowDefinitions="Auto, *, Auto"
                        RowSpacing="10">


                        <StackLayout Grid.Row="1" Spacing="10">
                            <Button
                                BackgroundColor="Transparent"
                                Command="{Binding NavigateToCommand}"
                                CommandParameter="MyCarsPage"
                                HorizontalOptions="Fill"
                                Text="Мои авто"
                                TextColor="White" />

                            <Button
                                BackgroundColor="Transparent"
                                Command="{Binding NavigateToCommand}"
                                CommandParameter="BillsPage"
                                HorizontalOptions="Fill"
                                Text="Счета"
                                TextColor="White" />
                            <Button
                                BackgroundColor="Transparent"
                                Command="{Binding NavigateToCommand}"
                                CommandParameter="PaymentsPage"
                                HorizontalOptions="Fill"
                                Text="Платежи"
                                TextColor="White" />
                        </StackLayout>

                        <Button
                            Grid.Row="2"
                            BackgroundColor="Transparent"
                            Command="{Binding LogoutCommand}"
                            HorizontalOptions="Center"
                            Text="Выйти"
                            TextColor="Red" />
                    </Grid>

                </Border>
            </Grid>
        </Grid>
    </Grid>
</ContentPage>